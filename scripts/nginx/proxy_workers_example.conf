server {
    listen 80 ;
    listen 443 ssl ;
    server_name example.dev *.example.dev;
    index index.php index.html index.htm default.php default.htm default.html;
    access_log /www/sites/example.dev/log/access.log main;
    error_log /www/sites/example.dev/log/error.log;
    location ~ ^/(\.user.ini|\.htaccess|\.git|\.env|\.svn|\.project|LICENSE|README.md) {
        return 404;
    }
    location ^~ /.well-known/acme-challenge {
        allow all;
        root /usr/share/nginx/html;
    }
    if ( $uri ~ "^/\.well-known/.*\.(php|jsp|py|js|css|lua|ts|go|zip|tar\.gz|rar|7z|sql|bak)$" ) {
        return 403;
    }
    root /www/sites/example.dev/index;
    error_page 404 /404.html;
    http2 on;
    if ($scheme = http) {
        return 301 https://$host$request_uri;
    }
    ssl_certificate /www/sites/example.dev/ssl/fullchain.pem;
    ssl_certificate_key /www/sites/example.dev/ssl/privkey.pem;
    ssl_protocols TLSv1.3 TLSv1.2;
    ssl_ciphers ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256:!aNULL:!eNULL:!EXPORT:!DSS:!DES:!RC4:!3DES:!MD5:!PSK:!KRB5:!SRP:!CAMELLIA:!SEED;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    error_page 497 https://$host$request_uri;
    proxy_set_header X-Forwarded-Proto https;

    # 变量上游需要显式 DNS 解析器
    resolver 1.1.1.1 8.8.8.8 valid=300s;
    resolver_timeout 5s;

    # 默认上游为根域 workers.dev
    set $target "workers.dev";
    # 仅二级前端：foo.example.dev → foo.workers.dev
    if ($host ~* "^([^.]+)\\.example\\.dev$") {
        set $target $1.workers.dev;
    }
    # 三段编码（-- 表示 .）：foo--bar.example.dev → foo.bar.workers.dev
    if ($host ~* "^([^.]+)--([^.]+)\\.example\\.dev$") {
        set $target $1.$2.workers.dev;
    }

    # 统一反代到上游（HTTPS + SNI）
    location / {
        proxy_set_header Host $target;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;

        proxy_ssl_server_name on;
        proxy_ssl_name $target;
        proxy_pass https://$target$request_uri;

        proxy_connect_timeout 5s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
        proxy_redirect off;
    }

    add_header Strict-Transport-Security "max-age=31536000";
}
